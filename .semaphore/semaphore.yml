---
version: v1.0
name: Benchmarking suite
execution_time_limit:
  hours: 3
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: 'registry.semaphoreci.com/ruby:2.6'
blocks:
- name: setup
  dependencies: []
  task:
    jobs:
    - name: setup
      commands:
      - checkout
      - cache store $SEMAPHORE_GIT_SHA .
      - curl -sL "https://keybase.io/crystal/pgp_keys.asc" | sudo apt-key add -
      - echo "deb https://dist.crystal-lang.org/apt crystal main" | sudo tee /etc/apt/sources.list.d/crystal.list
      - sudo apt-get update
      - sudo apt-get -y install crystal jq
      - shards build --static
      - cache store bin bin
      - bundle config path .cache
      - bundle install
      - cache store built-in .cache
      - bundle exec rake config

- name: ruby
  dependencies:
  - setup
  run:
    when: change_in('/ruby/')
  task:
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore bin
      - cache restore built-in
      - find bin -type f -exec chmod +x {} \;
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    env_vars:
    - name: CLEAN
      value: 'off'
    - name: COLLECT
      value: 'off'
    jobs:
    - name: syro
      commands:
      - mkdir -p .neph/ruby/syro
      - retry bin/neph ruby/syro --mode=CI
      - FRAMEWORK=ruby/syro bundle exec rspec .spec
    - name: sinatra
      commands:
      - mkdir -p .neph/ruby/sinatra
      - retry bin/neph ruby/sinatra --mode=CI
      - FRAMEWORK=ruby/sinatra bundle exec rspec .spec
    - name: rack_app
      commands:
      - mkdir -p .neph/ruby/rack_app
      - retry bin/neph ruby/rack_app --mode=CI
      - FRAMEWORK=ruby/rack_app bundle exec rspec .spec
    - name: camping
      commands:
      - mkdir -p .neph/ruby/camping
      - retry bin/neph ruby/camping --mode=CI
      - FRAMEWORK=ruby/camping bundle exec rspec .spec
    - name: roda
      commands:
      - mkdir -p .neph/ruby/roda
      - retry bin/neph ruby/roda --mode=CI
      - FRAMEWORK=ruby/roda bundle exec rspec .spec
    - name: agoo
      commands:
      - mkdir -p .neph/ruby/agoo
      - retry bin/neph ruby/agoo --mode=CI
      - FRAMEWORK=ruby/agoo bundle exec rspec .spec
    - name: rack-routing
      commands:
      - mkdir -p .neph/ruby/rack-routing
      - retry bin/neph ruby/rack-routing --mode=CI
      - FRAMEWORK=ruby/rack-routing bundle exec rspec .spec
    - name: hanami
      commands:
      - mkdir -p .neph/ruby/hanami
      - retry bin/neph ruby/hanami --mode=CI
      - FRAMEWORK=ruby/hanami bundle exec rspec .spec
    - name: flame
      commands:
      - mkdir -p .neph/ruby/flame
      - retry bin/neph ruby/flame --mode=CI
      - FRAMEWORK=ruby/flame bundle exec rspec .spec
    - name: hanami-api
      commands:
      - mkdir -p .neph/ruby/hanami-api
      - retry bin/neph ruby/hanami-api --mode=CI
      - FRAMEWORK=ruby/hanami-api bundle exec rspec .spec
    - name: pakyow
      commands:
      - mkdir -p .neph/ruby/pakyow
      - retry bin/neph ruby/pakyow --mode=CI
      - FRAMEWORK=ruby/pakyow bundle exec rspec .spec
    - name: grape
      commands:
      - mkdir -p .neph/ruby/grape
      - retry bin/neph ruby/grape --mode=CI
      - FRAMEWORK=ruby/grape bundle exec rspec .spec
    - name: cuba
      commands:
      - mkdir -p .neph/ruby/cuba
      - retry bin/neph ruby/cuba --mode=CI
      - FRAMEWORK=ruby/cuba bundle exec rspec .spec
    - name: rails
      commands:
      - mkdir -p .neph/ruby/rails
      - retry bin/neph ruby/rails --mode=CI
      - FRAMEWORK=ruby/rails bundle exec rspec .spec
