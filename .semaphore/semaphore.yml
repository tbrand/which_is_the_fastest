---
version: v1.0
name: Benchmarking suite
execution_time_limit:
  hours: 3
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
- name: setup
  dependencies: []
  task:
    jobs:
    - name: setup
      commands:
      - git clone --no-checkout $SEMAPHORE_GIT_URL $SEMAPHORE_GIT_DIR
      - cd $SEMAPHORE_GIT_DIR
      - checkout::switch_revision
      - git sparse-checkout init --cone
      - git sparse-checkout set tools Rakefile Gemfile shard.yml
      - git checkout
      - sudo snap install crystal --classic
      - sudo apt-get -y install libyaml-dev libevent-dev
      - shards build --static
      - cache store bin bin
      - bundle config path .cache
      - bundle install
      - cache store built-in .cache
      - bundle exec rake config
- name: pony
  dependencies:
  - setup
  task:
    prologue:
      commands:
      - git clone --no-checkout $SEMAPHORE_GIT_URL $SEMAPHORE_GIT_DIR
      - cd $SEMAPHORE_GIT_DIR
      - checkout::switch_revision
      - git sparse-checkout init --cone
      - git sparse-checkout set tools pony/ Rakefile Gemfile
      - git checkout
      - cache restore bin
      - cache restore built-in
      - find bin -type f -exec chmod +x {} \;
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    env_vars:
    - name: CLEAN
      value: 'off'
    - name: COLLECT
      value: 'off'
    jobs:
    - name: jennet
      commands:
      - cd pony/jennet && make build  -f .Makefile  && cd -
      - FRAMEWORK=pony/jennet bundle exec rspec .spec