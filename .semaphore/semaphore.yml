---
version: v1.0
name: Benchmarking suite
execution_time_limit:
  hours: 3
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
- name: setup
  dependencies: []
  task:
    jobs:
    - name: setup
      commands:
      - checkout
      - cache store $SEMAPHORE_GIT_SHA .
      - sudo snap install crystal --classic
      - sudo apt-get -y install libyaml-dev libevent-dev
      - shards build --static
      - cache store bin bin
      - bundle config path .cache
      - bundle install
      - cache store built-in .cache
      - bundle exec rake config
- name: java
  dependencies:
  - setup
  task:
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore bin
      - cache restore built-in
      - find bin -type f -exec chmod +x {} \;
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name: restheart
      commands:
      - cd java/restheart && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/restheart bundle exec rspec .spec
    - name: light-4j
      commands:
      - cd java/light-4j && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/light-4j bundle exec rspec .spec
    - name: jooby
      commands:
      - cd java/jooby && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/jooby bundle exec rspec .spec
    - name: javalin
      commands:
      - cd java/javalin && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/javalin bundle exec rspec .spec
    - name: act
      commands:
      - cd java/act && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/act bundle exec rspec .spec
    - name: rapidoid
      commands:
      - cd java/rapidoid && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/rapidoid bundle exec rspec .spec
    - name: blade
      commands:
      - cd java/blade && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/blade bundle exec rspec .spec
    - name: struts2
      commands:
      - cd java/struts2 && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/struts2 bundle exec rspec .spec
    - name: spring-framework
      commands:
      - cd java/spring-framework && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/spring-framework bundle exec rspec .spec
    - name: micronaut
      commands:
      - cd java/micronaut && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/micronaut bundle exec rspec .spec
    - name: spring-boot
      commands:
      - cd java/spring-boot && make build  -f .Makefile  && cd -
      - FRAMEWORK=java/spring-boot bundle exec rspec .spec
