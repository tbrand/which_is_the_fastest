---
version: v1.0
name: Benchmarking suite
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
execution_time_limit:
  hours: 24
blocks:
- name: setup
  dependencies: []
  task:
    jobs:
    - name: setup
      commands:
      - checkout
      - cache store $SEMAPHORE_GIT_SHA .
      - sudo apt-get update
      - sudo apt-get install build-essential libssl-dev git -y
      - git clone https://github.com/wg/wrk.git wrk
      - cd wrk && make
      - cache store wrk wrk
      - bundle config path .cache
      - bundle install
      - cache store built-in .cache
      - bundle exec rake config
- name: php
  dependencies:
  - setup
  run:
    when: change_in('/php/')
  task:
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name: setup
      commands:
      - checkout
- name: chubbyphp
  dependencies:
  - php
  run:
    when: change_in('/php/chubbyphp')
  task:
    env_vars:
    - name: LANGUAGE
      value: php
    - name: FRAMEWORK
      value: chubbyphp
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name: php-fpm
      commands:
      - make  -f php/chubbyphp/.Makefile build.php-fpm
      - bundle exec rspec .spec
      - make  -f php/chubbyphp/.Makefile collect.php-fpm
      - bundle exec rake db:raw_export
      env_vars:
      - name: ENGINE
        value: php-fpm
    - name: swoole
      commands:
      - make  -f php/chubbyphp/.Makefile build.swoole
      - bundle exec rspec .spec
      - make  -f php/chubbyphp/.Makefile collect.swoole
      - bundle exec rake db:raw_export
      env_vars:
      - name: ENGINE
        value: swoole
    - name: workerman
      commands:
      - make  -f php/chubbyphp/.Makefile build.workerman
      - bundle exec rspec .spec
      - make  -f php/chubbyphp/.Makefile collect.workerman
      - bundle exec rake db:raw_export
      env_vars:
      - name: ENGINE
        value: workerman
    - name: road-runner
      commands:
      - make  -f php/chubbyphp/.Makefile build.road-runner
      - bundle exec rspec .spec
      - make  -f php/chubbyphp/.Makefile collect.road-runner
      - bundle exec rake db:raw_export
      env_vars:
      - name: ENGINE
        value: road-runner
- name: cubex
  dependencies:
  - php
  run:
    when: change_in('/php/cubex')
  task:
    env_vars:
    - name: LANGUAGE
      value: php
    - name: FRAMEWORK
      value: cubex
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name: workerman
      commands:
      - make  -f php/cubex/.Makefile build.workerman
      - bundle exec rspec .spec
      - make  -f php/cubex/.Makefile collect.workerman
      - bundle exec rake db:raw_export
      env_vars:
      - name: ENGINE
        value: workerman
    - name: php-fpm
      commands:
      - make  -f php/cubex/.Makefile build.php-fpm
      - bundle exec rspec .spec
      - make  -f php/cubex/.Makefile collect.php-fpm
      - bundle exec rake db:raw_export
      env_vars:
      - name: ENGINE
        value: php-fpm
