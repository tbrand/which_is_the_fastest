---
version: v1.0
name: Benchmarking suite
execution_time_limit:
  hours: 24
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
- name: setup
  dependencies: []
  task:
    jobs:
    - name: setup
      commands:
      - checkout
      - cache store $SEMAPHORE_GIT_SHA .
      - sudo snap install crystal --classic
      - sudo apt-get -y install libyaml-dev libevent-dev
      - shards build --static
      - cache store bin bin
      - bundle config path .cache
      - bundle install
      - cache store built-in .cache
      - bundle exec rake config
- name: fsharp
  dependencies:
  - setup
  task:
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore bin
      - cache restore built-in
      - find bin -type f -exec chmod +x {} \;
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name: giraffe
      commands:
      - cd fsharp/giraffe && make build  -f .Makefile  && cd -
      - FRAMEWORK=fsharp/giraffe bundle exec rspec .spec
    - name: websharper
      commands:
      - cd fsharp/websharper && make build  -f .Makefile  && cd -
      - FRAMEWORK=fsharp/websharper bundle exec rspec .spec
    - name: saturn
      commands:
      - cd fsharp/saturn && make build  -f .Makefile  && cd -
      - FRAMEWORK=fsharp/saturn bundle exec rspec .spec
    - name: frank
      commands:
      - cd fsharp/frank && make build  -f .Makefile  && cd -
      - FRAMEWORK=fsharp/frank bundle exec rspec .spec
    - name: suave
      commands:
      - cd fsharp/suave && make build  -f .Makefile  && cd -
      - FRAMEWORK=fsharp/suave bundle exec rspec .spec
    - name: falco
      commands:
      - cd fsharp/falco && make build  -f .Makefile  && cd -
      - FRAMEWORK=fsharp/falco bundle exec rspec .spec
