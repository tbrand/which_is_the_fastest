---
version: v1.0
name: Benchmarking suite
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
execution_time_limit:
  hours: 24
blocks:
- name: setup
  dependencies: []
  task:
    jobs:
    - name: setup
      commands:
      - checkout
      - cache store $SEMAPHORE_GIT_SHA .
      - sudo apt-get update
      - sudo apt-get install build-essential libssl-dev git -y
      - git clone https://github.com/wg/wrk.git wrk
      - cd wrk && make
      - cache store wrk wrk
      - bundle config path .cache
      - bundle install
      - cache store built-in .cache
      - bundle exec rake config
- name: ruby
  dependencies:
  - setup
  run:
    when: change_in('/ruby/')
  task:
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name: setup
      commands:
      - checkout
- name: agoo
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/agoo')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: agoo
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        agoo:
          command: bundler exec ruby app.rb
      commands:
      - make  -f ruby/agoo/.Makefile build.{"agoo"=>{"command"=>"bundler exec ruby
        app.rb"}}
      - bundle exec rspec .spec
      - make  -f ruby/agoo/.Makefile collect.{"agoo"=>{"command"=>"bundler exec ruby
        app.rb"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          agoo:
            command: bundler exec ruby app.rb
- name: camping
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/camping')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: camping
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/camping/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/camping/.Makefile collect.{"puma"=>{"command"=>"bundle exec
        puma -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/camping/.Makefile build.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/camping/.Makefile collect.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/camping/.Makefile build.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/camping/.Makefile collect.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: cuba
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/cuba')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: cuba
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/cuba/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/cuba/.Makefile collect.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/cuba/.Makefile build.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/cuba/.Makefile collect.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/cuba/.Makefile build.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/cuba/.Makefile collect.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: grape
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/grape')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: grape
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/grape/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/grape/.Makefile collect.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/grape/.Makefile build.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/grape/.Makefile collect.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/grape/.Makefile build.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/grape/.Makefile collect.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: hanami-api
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/hanami-api')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: hanami-api
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/hanami-api/.Makefile build.{"puma"=>{"command"=>"bundle exec
        puma -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/hanami-api/.Makefile collect.{"puma"=>{"command"=>"bundle exec
        puma -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/hanami-api/.Makefile build.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/hanami-api/.Makefile collect.{"iodine"=>{"command"=>"bundle
        exec iodine -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/hanami-api/.Makefile build.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/hanami-api/.Makefile collect.{"falcon"=>{"command"=>"bundle
        exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: rack-routing
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/rack-routing')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: rack-routing
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/rack-routing/.Makefile build.{"puma"=>{"command"=>"bundle exec
        puma -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rack-routing/.Makefile collect.{"puma"=>{"command"=>"bundle
        exec puma -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/rack-routing/.Makefile build.{"iodine"=>{"command"=>"bundle
        exec iodine -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rack-routing/.Makefile collect.{"iodine"=>{"command"=>"bundle
        exec iodine -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/rack-routing/.Makefile build.{"falcon"=>{"command"=>"bundle
        exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rack-routing/.Makefile collect.{"falcon"=>{"command"=>"bundle
        exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: rack_app
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/rack_app')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: rack_app
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/rack_app/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rack_app/.Makefile collect.{"puma"=>{"command"=>"bundle exec
        puma -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/rack_app/.Makefile build.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rack_app/.Makefile collect.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/rack_app/.Makefile build.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rack_app/.Makefile collect.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: rails
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/rails')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: rails
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/rails/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rails/.Makefile collect.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/rails/.Makefile build.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rails/.Makefile collect.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/rails/.Makefile build.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/rails/.Makefile collect.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: roda
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/roda')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: roda
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/roda/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/roda/.Makefile collect.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/roda/.Makefile build.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/roda/.Makefile collect.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/roda/.Makefile build.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/roda/.Makefile collect.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: sinatra
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/sinatra')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: sinatra
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/sinatra/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/sinatra/.Makefile collect.{"puma"=>{"command"=>"bundle exec
        puma -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/sinatra/.Makefile build.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/sinatra/.Makefile collect.{"iodine"=>{"command"=>"bundle exec
        iodine -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/sinatra/.Makefile build.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/sinatra/.Makefile collect.{"falcon"=>{"command"=>"bundle exec
        falcon serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
- name: syro
  dependencies:
  - ruby
  run:
    when: change_in('/ruby/syro')
  task:
    env_vars:
    - name: LANGUAGE
      value: ruby
    - name: FRAMEWORK
      value: syro
    prologue:
      commands:
      - cache restore $SEMAPHORE_GIT_SHA
      - cache restore wrk
      - sudo install wrk /usr/local/bin
      - cache restore bin
      - cache restore built-in
      - sem-service start postgres
      - createdb -U postgres -h 0.0.0.0 benchmark
      - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
      - bundle config path .cache
      - bundle install
      - bundle exec rake config
    jobs:
    - name:
        puma:
          command: bundle exec puma -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/syro/.Makefile build.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/syro/.Makefile collect.{"puma"=>{"command"=>"bundle exec puma
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          puma:
            command: bundle exec puma -p 3000 -w $(nproc)
    - name:
        iodine:
          command: bundle exec iodine -p 3000 -w $(nproc)
      commands:
      - make  -f ruby/syro/.Makefile build.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/syro/.Makefile collect.{"iodine"=>{"command"=>"bundle exec iodine
        -p 3000 -w $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          iodine:
            command: bundle exec iodine -p 3000 -w $(nproc)
    - name:
        falcon:
          command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
      commands:
      - make  -f ruby/syro/.Makefile build.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rspec .spec
      - make  -f ruby/syro/.Makefile collect.{"falcon"=>{"command"=>"bundle exec falcon
        serve --bind http://0.0.0.0:3000 --count $(nproc)"}}
      - bundle exec rake db:export
      env_vars:
      - name: VARIANT
        value:
          falcon:
            command: bundle exec falcon serve --bind http://0.0.0.0:3000 --count $(nproc)
